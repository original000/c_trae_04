# 高性能异步日志系统

一个基于C++11的高性能异步日志系统，具有以下特性：

## 特性

- **异步日志**：使用后台线程写入日志，不阻塞主线程
- **Lock-free队列**：单生产者多消费者(MPSC)环形队列，无锁操作，性能高
- **日志轮转**：自动按文件大小(100MB)或时间(00:00)轮转日志
- **日志清理**：自动删除7天前的旧日志
- **日志格式**：包含时间戳、日志级别和消息内容
- **日志级别**：支持INFO、WARN、ERROR三个级别
- **宏定义**：提供LOG_INFO、LOG_WARN、LOG_ERROR宏，使用方便

## 项目结构

```
.
├── AsyncLogger.h    # 异步日志器头文件
├── AsyncLogger.cpp  # 异步日志器实现文件
├── LogFile.h        # 日志文件头文件
├── LogFile.cpp      # 日志文件实现文件
├── LogStream.h      # 日志流头文件
├── Logger.h          # 日志器头文件
├── Logger.cpp        # 日志器实现文件
├── CMakeLists.txt   # CMake构建文件
├── main.cpp          # 演示程序
└── README.md         # 项目说明
```

## 构建和运行

### 环境要求

- Windows操作系统
- GCC编译器(版本5.0.0及以上)
- CMake(版本3.10及以上)

### 构建步骤

1. 创建构建目录：
   ```bash
   mkdir build
   cd build
   ```

2. 运行CMake生成Makefile：
   ```bash
   cmake ..
   ```

3. 编译项目：
   ```bash
   make
   ```

### 运行演示程序

```bash
./AsyncLogger.exe
```

演示程序将创建8个线程，每个线程狂刷10000条日志消息。

## 使用方法

### 初始化日志系统

```cpp
#include "Logger.h"

int main() {
    // 初始化异步日志器，指定日志文件前缀
    AsyncLogger logger("my_log");
    g_asyncLogger = &logger;
    logger.start();

    // ... 你的代码 ...

    // 停止日志器
    logger.stop();

    return 0;
}
```

### 记录日志

使用LOG_INFO、LOG_WARN、LOG_ERROR宏记录不同级别的日志：

```cpp
LOG_INFO << "这是一条INFO级别的日志";
LOG_WARN << "这是一条WARN级别的日志";
LOG_ERROR << "这是一条ERROR级别的日志";
```

支持所有基础类型的输出：

```cpp
int i = 42;
float f = 3.14;
double d = 2.71828;
std::string s = "Hello, World!";

LOG_INFO << "整数: " << i;
LOG_INFO << "浮点数: " << f;
LOG_INFO << "双精度数: " << d;
LOG_INFO << "字符串: " << s;
```

## 日志格式

日志格式如下：

```
2025-04-05 18:23:45.123 [INFO] 这是一条日志消息
```

其中：
- `2025-04-05`：日期(年-月-日)
- `18:23:45.123`：时间(时:分:秒.毫秒)
- `[INFO]`：日志级别
- `这是一条日志消息`：日志内容

## 日志轮转

日志系统会自动进行日志轮转：

1. **按文件大小轮转**：当日志文件大小超过100MB时，会创建一个新的日志文件
2. **按时间轮转**：每天00:00会创建一个新的日志文件

日志文件命名格式为：`{prefix}.log.{yyyymmdd}`

例如：`my_log.log.20250405`

## 日志清理

日志系统会自动删除7天前的旧日志文件，以节省磁盘空间。

## 性能优化

- **异步写入**：日志消息先写入内存队列，后台线程再批量写入文件，减少IO操作
- **Lock-free队列**：使用原子操作实现无锁队列，避免线程阻塞，提高并发性能
- **批量写入**：后台线程批量处理队列中的日志消息，减少文件IO次数
- **缓冲区**：使用缓冲区减少磁盘IO操作

## 注意事项

1. 确保在使用日志宏之前初始化异步日志器
2. 日志系统不支持多进程写入同一个日志文件
3. 日志文件的大小和保留天数可以在LogFile.h中修改

## 许可证

MIT License
